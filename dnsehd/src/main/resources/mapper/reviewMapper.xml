<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.application.dnsehd.dao.ReviewDAO">

	<insert id="insertReview" parameterType="ReviewDTO" useGeneratedKeys="true" keyProperty="reviewNo">
		INSERT INTO REVIEWS (
			REVIEW_TITLE,
			REVIEW_CONTENT,
			REVIEW_SCORE,
			REVIEW_DT,
			MEMBER_ID
		)
		VALUES (
			#{reviewTitle},
			#{reviewContent},
			#{reviewScore},
			now(),
			#{memberId}
		)
		<selectKey keyColumn="GENERATED_KEY" keyProperty="reviewNo" order="AFTER" resultType="int">
		    SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	<insert id="insertReviewImg" parameterType="ReviewImgDTO">
		INSERT INTO REVIEW_IMAGES (
				REVIEW_NO,
				REVIEW_IMG_NM,
				REVIEW_IMG_UUID
		)
		VALUES (
				#{reviewNo},
				#{reviewImgNm},
				#{reviewImgUUID}
		)
	</insert>
		
	<resultMap type="hashmap" id="review">
		<result column="REVIEW_NO" property="reviewNo"/>
		<result column="REVIEW_TITLE" property="reviewTitle"/>
		<result column="REVIEW_CONTENT" property="reviewContent"/>
		<result column="REVIEW_SCORE" property="reviewScore"/>
		<result column="REVIEW_DT" property="reviewDt"/>
		<result column="MEMBER_ID" property="memberId"/>
		<result column="REVIEW_IMG_NO" property="reviewImgNo"/>
		<result column="REVIEW_IMG_NM" property="reviewImgNm"/>
		<result column="REVIEW_IMG_UUID" property="reviewImgUUID"/>
	</resultMap>
	
	<select id="selectReviewList" resultMap="review">
		SELECT 
				R.REVIEW_NO AS REVIEW_NO,
				R.REVIEW_TITLE AS REVIEW_TITLE,
				R.REVIEW_CONTENT AS REVIEW_CONTENT,
				R.REVIEW_SCORE AS REVIEW_SCORE,
				R.REVIEW_DT AS REVIEW_DT,
				R.MEMBER_ID AS MEMBER_ID,
				RI.REVIEW_IMG_NO AS REVIEW_IMG_NO,
				RI.REVIEW_IMG_NM AS REVIEW_IMG_NM,
				RI.REVIEW_IMG_UUID AS REVIEW_IMG_UUID
		FROM
				REVIEWS AS R
		JOIN    REVIEW_IMAGES AS RI
				ON R.REVIEW_NO = RI.REVIEW_NO
		ORDER BY
				R.REVIEW_NO DESC
				
	</select>
	
	<select id="selectReviewDetail" parameterType="int" resultMap="review">
		SELECT 
				R.REVIEW_NO AS REVIEW_NO,
				R.REVIEW_TITLE AS REVIEW_TITLE,
				R.REVIEW_CONTENT AS REVIEW_CONTENT,
				R.REVIEW_SCORE AS REVIEW_SCORE,
				R.REVIEW_DT AS REVIEW_DT,
				R.MEMBER_ID AS MEMBER_ID,
				RI.REVIEW_IMG_NO AS REVIEW_IMG_NO,
				RI.REVIEW_IMG_NM AS REVIEW_IMG_NM,
				RI.REVIEW_IMG_UUID AS REVIEW_IMG_UUID
		FROM
				REVIEWS AS R
		JOIN    REVIEW_IMAGES AS RI
				ON R.REVIEW_NO = RI.REVIEW_NO
		WHERE
				R.REVIEW_NO = #{reviewNo}
	</select>
	
	<select id="selectMyReviewList" parameterType="String" resultType="ReviewDTO">
		SELECT
				*
		FROM
				REVIEWS
		WHERE
				MEMBER_ID = #{memberId}
	</select>
	
	<update id="updateMyReview" parameterType="ReviewDTO">
		UPDATE
				REVIEWS
		SET
				REVIEW_TITLE = #{reviewTitle},
				REVIEW_CONTENT = #{reviewContent},
				REVIEW_SCORE = #{reviewScore},
				REVIEW_DT = now(),
				MEMBER_ID = #{memberId}
		WHERE
				REVIEW_NO = #{reviewNo}
	</update>

	<update id="updateMyReviewImg" parameterType="ReviewImgDTO">
	    UPDATE 
	    		REVIEW_IMAGES
	    SET 
	    		REVIEW_IMG_NM = #{reviewImgNm},
	        	REVIEW_IMG_UUID = #{reviewImgUUID}
	    WHERE 
	    		REVIEW_NO = #{reviewNo}
	</update>
		
	<delete id="deleteReview" parameterType="int">
		DELETE FROM
				REVIEWS
		WHERE
				REVIEW_NO = #{reviewNo}
	</delete>
	
	<delete id="deleteReviewImg" parameterType="int">
		DELETE FROM
				REVIEW_IMAGES
		WHERE
				REVIEW_NO = #{reviewNo}
	</delete>

</mapper>